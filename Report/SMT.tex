


\section{SMT Model}

\subsection{Decision Variables}

Let $n$ be the number of teams, and let $W = \{1, \dots, n - 1\}$ denote the set of tournament weeks. Each week is divided into $n/2$ periods. Let $\mathcal{M}_w$ be the set of matches scheduled in week $w \in W$.

We define an integer decision variable:
\[
p_{w,i,j} \in \{1, \dots, n/2\}
\]
for each match between any pair of teams $(i,j)$, where $(i,j) \in \mathcal{M}_w$, indicating the period during which this match takes place in week $w$.

The model is encoded using the theory of Linear Integer Arithmetic (LIA), extended with pseudo-Boolean constraints for cardinality.

\subsubsection{Pre-solving with the Circle Method}
\label{CircleMatching}

We avoid additional decision variables by precomputing which teams $(i, j)$ play in each week $w$ using the fast and classical \emph{circle method} for round-robin tournaments \cite{dewerra1999}, which was already explained above.
In practice, this greatly reduces the number of SMT variables and constraints. Thanks to pre-solving, we can solve instances with up to $n=20$ teams—and usually even $n=22$ sometimes — within the 5-minute limit. This is $2$ to $4$ teams more than our first SMT models that generated all possible matches as decision variables.

%One team (the pivot) is fixed, and the other $n - 1$ teams are placed in a circle. Each week, the pivot plays a rotating team, while the remaining teams are paired by connecting opposite positions in the circle. This rotation continues for $n - 1$ weeks. The construction guarantees:
%\begin{itemize}
%    \item Each team plays once per week;
%    \item No match is repeated;
%    \item The total number of matches is $\frac{n(n-1)}{2}$.
%\end{itemize}

%Example for $n = 6$:
%\[
%\text{Week 1: } (6,1), (2,5), (3,4) \quad \text{Week 2: } (6,2), (3,1), (4,5), \dots
%\]

% Mathematically, this yields a 1-factorization of the complete graph $K_n$, ensuring correctness. 

\subsection{Objective Function}

For the sake of solving the home-away balancing task, there is a simple mathematical algorithm. It does not need optimization with SMT.
If (i,j) is a game between any two teams $i$ and $j$ then the modulo arithmetic's algorithm is this:
\[
i,j\in\{1,\dots,n\},\quad
d\equiv j-i\pmod n,\;1\le d\le n-1,
\qquad
\text{home}(i,j)=
\begin{cases}
i,&d<\tfrac n2,\\
j,&d\ge\tfrac n2,
\end{cases}
% \quad
% \text{away}(i,j)=\text{the other vertex.}
\]
By construction, it achieves an absolute disbalance of home/away games equal to 1 per each team. In total, the sum of the absolute disbalance values will be n.
Theoretically, it is minimal for even n.

We use this mathematical approach in the decisional version, so the json results for the decisional version are also home/away optimal.

But to study the solver overhead of enforcing this balance via optimization, we performed a dedicated experiment. 
We define for team t - absolute difference between home and away games as:
\[
\mathit{abs\_diff}_t \;=\;\bigl\lvert (n-1)\;-\;2\cdot\mathit{away\_count}_t\bigr\rvert
\]
% equals 1 for every team, so that
% \[
% \sum_{t=1}^{n}\mathit{abs\_diff}_t \;=\;n,
% \]

 We introduced the global imbalance metric
\[
\texttt{sumDif} \;=\;\sum_{t=1}^{n}\mathit{abs\_diff}_t
\]
as our first attempt to construct an objective function.  Also, we added the constraint
\[
\texttt{sumDif} \;\ge\; n
\]

We added following additional symmetry‑breaking constraint (w.r.t to team numbering) on the per‑team imbalances:
\[
\mathit{abs\_diff}_{t_1}\;\ge\;\mathit{abs\_diff}_{t_2}\;\ge\;\cdots\ge\;\mathit{abs\_diff}_{t_n},
\]
and then instructed Z3 to minimize
\[
\max_{t}\mathit{abs\_diff}_t = abs\_diff_{0}
\]

In our experiments, it appeared that instead of minimizing $\texttt{sumDif}$, it is better to minimize $\max_{t}\mathit{abs\_diff}_t$ objective, as the optimization becomes almost an order of magnitude faster. 
\subsection{Constraints}

\paragraph{Domain Constraints.}
Each decision variable must be assigned a valid period:
\[
\forall (w,i,j): \quad 1 \leq p_{w,i,j} \leq n/2
\]

\paragraph{Unique Match per Period per Week.}
For each week $w \in W$ and period $k \in \{1, \dots, n/2\}$, exactly one match must be assigned to that period:
\[
\sum_{(i,j) \in \mathcal{M}_w} [p_{w,i,j} = k] = 1
\]

\paragraph{Period Load per Team.}
Each team must appear at most twice in each period across the tournament:
\[
\forall t \in [n], \forall k \in \{1, \dots, n/2\}: \quad \sum_{(w,i,j) : t \in \{i,j\}} [p_{w,i,j} = k] \leq 2
\]

\subsubsection*{Symmetry Breaking Constraints}

\paragraph{Fixed Periods in First Week.}
To reduce the search space, we fix the period assignment of all matches in the first week:
\[
\forall k \in \{1, \dots, n/2\},\quad p_{1,i_k,j_k} = k
\]
where $(i_k, j_k)$ is the $k$-th match in a lexicographically sorted list of matches in week 1. This removes the permutation symmetry for the period labels.

In our SMT tests more complicated constraints - like lexicographical constraints on period assignment vectors for chosen pairs of teams - did not bring any noticeable additional improvements, as well as adding redundant constraints. 

% \paragraph{Lexicographic Team Schedule Ordering.}
% Let $T_1$ and $T_2$ be the last two teams in lexicographic order. Let $\vec{v}_1$ and $\vec{v}_2$ be the sequences of period variables corresponding to matches involving $T_1$ and $T_2$, respectively. Then, we enforce:
% \[
% \vec{v}_1 \leq_{\text{lex}} \vec{v}_2
% \]
% This is encoded using a sequence of implications to ensure that if all earlier positions are equal, the first differing value in $\vec{v}_1$ must be less than or equal to the corresponding one in $\vec{v}_2$.

\subsection{Validation}

\paragraph{Solver.}
The model was implemented in Python using the Z3 SMT solver. A custom tactic pipeline was used to enable pseudo-Boolean cardinality constraints translation into bit-vector constraints for speed.
%\[
%\texttt{Then(`card2bv', `smt')}
%\]

\subsection*{Experimental Results (Decision version, SMT in Z3)}

We tested the SMT model (without home-away optimization) using Z3 on increasing values of $n$, with and without symmetry breaking. All runs were limited to 300 seconds. The results in Table~\ref{tab:smt-results} show that enabling symmetry breaking significantly improves performance, especially for larger instances.

\begin{table}[h!]
\centering
\caption{Runtime in seconds for SMT (decision version), Z3 solver, with and without symmetry breaking (SB).}
\label{tab:smt-results}
\begin{tabular}{|c|c|c|}
\hline
\textbf{Number of Teams} & \textbf{SB Enabled} & \textbf{SB Disabled} \\
\hline
6  & 0 & 0 \\
8  & 0 & 0 \\
10 & 0 & 0 \\
12 & 0 & 1 \\
14 & 0 & 0 \\
16 & 0 & 2 \\
18 & 8 & 17 \\
20 & 5 & 42 \\
\hline
\end{tabular}
\end{table}

For our SMT model, we observed that the simple version (first week periods were fixed) of symmetry breaking consistently reduced runtime for bigger $n$, especially beyond $n = 16$. Without SB, solving $n=20$ takes $8$ times longer.

Though we need to mention that for a fixed $n$ there is still some variation between runs - due to the solver's heuristic choices adding some randomness. In some cases $n = 22$ gets solved on our hardware, while often it times out, so it was not included in the final table.

\subsection*{Experimental Results (Optimization version, SMT in Z3)}

We extended the SMT model to solve the optimization version of the problem, where the objective is to minimize the maximal (w.r.t to all teams) absolute discrepancy in home/away balance. 
Theoretically, our objective - maximal absolute discrepancy - being equal to $1$ is equivalent to reaching the optimum, and indeed this optimum value was reached in all tested instances.
%For $n$ teams, the theoretical optimum for the sum of absolute discrepancies is $n$.  

Table~\ref{tab:smt-opt-results} reports the total solving time (in seconds) for various team sizes, both with and without symmetry breaking (SB). All runs were performed with Z3 under a 5-minute timeout. In all cases, the solver found and proved optimal solutions within the time limit.

\begin{table}[h!]
\centering
\caption{Runtime in seconds for SMT (optimization version), Z3 solver, with and without symmetry breaking (SB). The objective function, $\max_{t}\mathit{abs_diff}_t$, in every case was optimal, and the value is shown in bold.}
\label{tab:smt-opt-results}
\begin{tabular}{|c|c|c|}
\hline
\textbf{Number of Teams} & \textbf{SB Enabled} & \textbf{SB Disabled} \\
\hline
6  & 0.00\textbar\textbf{1} & 0.00\textbar\textbf{1} \\
8  & 0.00\textbar\textbf{1} & 0.00\textbar\textbf{1} \\
10 & 0.00\textbar\textbf{1} & 0.00\textbar\textbf{1} \\
12 & 3.00\textbar\textbf{1} & 6.00\textbar\textbf{1} \\
14 & 4.00\textbar\textbf{1} & 11.00\textbar\textbf{1} \\
16 & 127.00\textbar\textbf{1} & 44.00\textbar\textbf{1} \\
18 & 189.00\textbar\textbf{1} & 257.00\textbar\textbf{1} \\
20 & 149.00\textbar\textbf{1} & 154.00\textbar\textbf{1} \\
\hline
\end{tabular}
\end{table}

We observe that for the SMT optimization version, symmetry breaking has no such dramatic impact for bigger $n$, 
though it helped in every case except for $n = 16$. For $n = 12$ and $n = 14$, SB yields a $2$ times and $3$ times improvement.

Though there is a noticeable variance due to solver heuristic choices, the observations made above are true for the majority of the re-runs, if made. 

% \subsection*{Experimental Results (Optimization version, SMT in Z3)}

% We tested the SMT model (without home-away optimization) using Z3 on increasing values of $n$, with and without symmetry breaking. All runs were limited to 300 seconds. The results in Table~\ref{tab:smt-results} show that enabling symmetry breaking significantly improves performance, especially for larger instances.

